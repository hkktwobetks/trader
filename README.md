# trader

Discord/LLM シグナルを起点としたトレード実行と、ブローカー連携（Alpaca / Paper）を行うバックエンド。  
詳細は [backend/README.md](backend/README.md) を参照。

---

## データ分析基盤の設計（案）

現行の「シグナル → 注文 → 約定・ポジション・PnL」に加え、**過去データの取得**と**パフォーマンス分析・バックテスト**が可能なデータ分析基盤を追加するための設計案である。

### 1. 目的・スコープ

| 項目 | 内容 |
|------|------|
| **過去データの取得** | 銘柄別の価格・出来高・分割調整済み系列などを取得・蓄積する |
| **パフォーマンス分析** | 実績（約定・ポジション・PnL）に基づくリターン・リスク・ドローダウンなどの分析 |
| **バックテスト** | 過去データ上で戦略（ルール or シグナル再生）をシミュレーションし、成績を評価する |

既存の `Order` / `Execution` / `Position` / `PnL` はそのまま活用し、**時系列のマーケットデータ**と**分析・バックテスト用のレイヤ**を足す形とする。

### 2. アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────┐
│ データソース                                                     │
│ ・ブローカーAPI（Alpaca bars など）                              │
│ ・必要に応じて外部（Yahoo Finance, Polygon 等）                   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ データ取得・正規化レイヤ（Ingestion）                             │
│ ・バー/ティックの取得ジョブ（スケジュール or オンデマンド）       │
│ ・銘柄マスタ・分割調整の扱い                                     │
│ ・共通スキーマ（timestamp, open, high, low, close, volume）      │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ ストレージ                                                       │
│ ・既存 DB: 約定・ポジション・PnL（実績）                          │
│ ・時系列データ: 価格・出来高（新規テーブル or 時系列DB/ファイル）  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ 分析・バックテストレイヤ                                         │
│ ・パフォーマンス分析: リターン・シャープ・ドローダウン・銘柄別    │
│ ・バックテストエンジン: 期間指定・戦略実行・スリッページ簡易モデル │
│ ・API / ダッシュボード: 既存 FastAPI・dashboard との連携         │
└─────────────────────────────────────────────────────────────────┘
```

### 3. データモデル（追加案）

- **MarketBar（または OHLCV）**  
  - 銘柄・時間足・日時・OHLC・出来高・調整フラグ等。  
  - 既存 DB にテーブル追加するか、時系列専用ストア（例: TimescaleDB / パーティション表 / Parquet）を検討する。

- **既存モデルの活用**  
  - `Execution` → 実績リターン・約定価格時系列の元データ。  
  - `PnL` → 日次実績 PnL。  
  - `Signal` → バックテスト時の「シグナル再生」の入力として利用可能。

### 4. データ取得（Ingestion）

- **ブローカー経由**  
  - Alpaca: ヒストリカルバー API で取得。  
- **取得単位**  
  - 銘柄 × 時間足（1分/5分/日足など）× 期間。  
- **運用**  
  - 初回はバッチで過去一定期間を取得。  
  - 以降は定期ジョブで最新分を追加（既存 scheduler 拡張 or 別ワーカー）。  

必要に応じて、無料枠の範囲で Yahoo Finance 等をフォールバックまたは補完用に検討する。

### 5. パフォーマンス分析

- **入力**  
  - `Execution` + `Position` + `PnL` および、必要なら `MarketBar`（評価価格の補完）。  
- **出力例**  
  - 総リターン・期間リターン（日/週/月）。  
  - シャープレシオ（年率化など）。  
  - 最大ドローダウン・ドローダウン期間。  
  - 銘柄別・セクター別寄与。  
- **提供方法**  
  - 集計結果を FastAPI のエンドポイントで返す。  
  - 既存ダッシュボードに「パフォーマンス」タブやグラフを追加する。

### 6. バックテスト基盤

- **入力**  
  - 戦略: ルールベース（例: 移動平均クロス）または、保存済み `Signal` の再生。  
  - 対象銘柄・期間。  
  - 使用する価格データ（`MarketBar` 等）。  
- **エンジン**  
  - 期間内を時系列で走査。  
  - シグナル or ルールでエントリー/エグジットを決定。  
  - 約定をシミュレーション（終値約定 or 簡易スリッページモデル）。  
  - ポジション・評価損益・実現損益を計算。  
- **出力**  
  - バックテスト期間のリターン・シャープ・ドローダウン・約定一覧。  
  - 実績分析と同様に API/ダッシュボードで表示できる形式にする。

### 7. 実装フェーズ（案）

| フェーズ | 内容 |
|----------|------|
| **Phase 1** | 過去データ取得パイプラインの設計・実装（Alpaca 等 1 ソースから開始）。ストレージスキーマとジョブの追加。 |
| **Phase 2** | 実績ベースのパフォーマンス分析（リターン・ドローダウン・銘柄別）。API とダッシュボードの拡張。 |
| **Phase 3** | バックテストエンジン（日足ベースの簡易版から）。戦略パラメータと結果の保存・表示。 |

---

上記は現時点の設計案である。実装時にストレージ選定（既存 DB のみで足すか時系列DBを導入するか）や、利用するブローカー・データソースに応じて見直す。
