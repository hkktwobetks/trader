<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trader Dashboard</title>
<style>
  :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff; --green: #3fb950; --red: #f85149; --yellow: #d29922; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  .container { max-width: 900px; margin: 0 auto; padding: 24px 16px; }
  h1 { font-size: 1.5rem; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
  h1 span { font-size: 1.8rem; }
  h2 { font-size: 1.1rem; color: var(--muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }

  .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }

  .status-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; }
  .status-item { flex: 1; min-width: 180px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .status-item .label { color: var(--muted); font-size: 0.8rem; text-transform: uppercase; margin-bottom: 4px; }
  .status-item .value { font-size: 1.2rem; font-weight: 600; }
  .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
  .dot.green { background: var(--green); }
  .dot.red { background: var(--red); }
  .dot.yellow { background: var(--yellow); }

  label { display: block; color: var(--muted); font-size: 0.85rem; margin-bottom: 4px; }
  input[type="text"], textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; color: var(--text); font-family: monospace; font-size: 0.9rem; margin-bottom: 12px; }
  textarea { min-height: 60px; resize: vertical; }
  input:focus, textarea:focus { outline: none; border-color: var(--accent); }

  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: opacity .15s; }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }

  .result { margin-top: 12px; padding: 12px; border-radius: 6px; font-size: 0.9rem; display: none; }
  .result.ok { display: block; background: #0d2818; border: 1px solid var(--green); color: var(--green); }
  .result.err { display: block; background: #2d1117; border: 1px solid var(--red); color: var(--red); }

  .signals-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .signals-table th { text-align: left; color: var(--muted); padding: 8px; border-bottom: 1px solid var(--border); font-weight: 500; }
  .signals-table td { padding: 8px; border-bottom: 1px solid var(--border); }
  .signals-table tr:hover { background: rgba(88,166,255,0.05); }
  .side-buy { color: var(--green); font-weight: 600; }
  .side-sell { color: var(--red); font-weight: 600; }

  .help-text { color: var(--muted); font-size: 0.8rem; margin-bottom: 16px; line-height: 1.6; }

  .tab-bar { display: flex; gap: 0; margin-bottom: 0; border-bottom: 1px solid var(--border); }
  .tab { padding: 10px 20px; cursor: pointer; color: var(--muted); font-size: 0.9rem; border-bottom: 2px solid transparent; transition: all .15s; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  @media (max-width: 600px) { .status-row { flex-direction: column; } }
</style>
</head>
<body>
<div class="container">
  <h1><span>ğŸ“ˆ</span> Trader Dashboard</h1>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <div class="status-row">
    <div class="status-item">
      <div class="label">Twitter Cookie</div>
      <div class="value" id="cookie-status"><span class="dot yellow"></span>èª­è¾¼ä¸­...</div>
    </div>
    <div class="status-item">
      <div class="label">Broker</div>
      <div class="value" id="broker-status"><span class="dot yellow"></span>èª­è¾¼ä¸­...</div>
    </div>
    <div class="status-item">
      <div class="label">LLM</div>
      <div class="value" id="llm-status"><span class="dot yellow"></span>èª­è¾¼ä¸­...</div>
    </div>
  </div>

  <!-- ã‚¿ãƒ– -->
  <div class="tab-bar">
    <div class="tab active" data-tab="cookies">ğŸ”‘ Cookieè¨­å®š</div>
    <div class="tab" data-tab="signals">ğŸ“Š ã‚·ã‚°ãƒŠãƒ«</div>
    <div class="tab" data-tab="orders">ğŸ“‹ æ³¨æ–‡</div>
  </div>

  <!-- Cookie å…¥åŠ›ã‚¿ãƒ– -->
  <div class="tab-content active" id="tab-cookies">
    <div class="card" style="margin-top:16px">
      <h2>Twitter Cookie ã‚’å…¥åŠ›</h2>
      <p class="help-text">
        ãƒ–ãƒ©ã‚¦ã‚¶ã® DevTools â†’ Application â†’ Cookies â†’ twitter.com ã‹ã‚‰<br>
        <code>auth_token</code> ã¨ <code>ct0</code> ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
        ã¾ãŸã¯ã€Cookieæ–‡å­—åˆ—ã‚’ã¾ã¨ã‚ã¦è²¼ã‚Šä»˜ã‘ã‚‹ã¨è‡ªå‹•è§£æã—ã¾ã™ã€‚
      </p>

      <label for="cookie-paste">Cookie æ–‡å­—åˆ—ï¼ˆã¾ã¨ã‚ã¦è²¼ã‚Šä»˜ã‘å¯ï¼‰</label>
      <textarea id="cookie-paste" placeholder="auth_token=xxxxx; ct0=yyyyy; ..."></textarea>

      <label for="auth-token">auth_token</label>
      <input type="text" id="auth-token" placeholder="40æ–‡å­—ã®16é€²æ–‡å­—åˆ—">

      <label for="ct0">ct0</label>
      <input type="text" id="ct0" placeholder="ct0 ã®å€¤">

      <button class="btn btn-primary" id="save-btn" onclick="saveCookies()">
        ğŸ’¾ ä¿å­˜ &amp; ãƒ†ã‚¹ãƒˆ
      </button>
      <button class="btn btn-outline" style="margin-left:8px" onclick="checkStatus()">
        ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
      </button>

      <div class="result" id="save-result"></div>
    </div>
  </div>

  <!-- ã‚·ã‚°ãƒŠãƒ«ã‚¿ãƒ– -->
  <div class="tab-content" id="tab-signals">
    <div class="card" style="margin-top:16px">
      <h2>æœ€æ–°ã‚·ã‚°ãƒŠãƒ«</h2>
      <table class="signals-table">
        <thead><tr><th>æ™‚åˆ»</th><th>éŠ˜æŸ„</th><th>æ–¹å‘</th><th>ä¿¡é ¼åº¦</th><th>ã‚½ãƒ¼ã‚¹</th></tr></thead>
        <tbody id="signals-body"><tr><td colspan="5" style="color:var(--muted)">èª­è¾¼ä¸­...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- æ³¨æ–‡ã‚¿ãƒ– -->
  <div class="tab-content" id="tab-orders">
    <div class="card" style="margin-top:16px">
      <h2>æ³¨æ–‡å±¥æ­´</h2>
      <table class="signals-table">
        <thead><tr><th>æ™‚åˆ»</th><th>éŠ˜æŸ„</th><th>æ–¹å‘</th><th>æ•°é‡</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr></thead>
        <tbody id="orders-body"><tr><td colspan="5" style="color:var(--muted)">èª­è¾¼ä¸­...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API = location.origin;

// --- ã‚¿ãƒ–åˆ‡æ›¿ ---
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// --- Cookie æ–‡å­—åˆ—ã®è‡ªå‹•è§£æ ---
document.getElementById('cookie-paste').addEventListener('input', (e) => {
  const raw = e.target.value;
  const pairs = raw.split(/;\s*/);
  for (const p of pairs) {
    const [k, ...v] = p.split('=');
    const key = k.trim();
    const val = v.join('=').trim();
    if (key === 'auth_token') document.getElementById('auth-token').value = val;
    if (key === 'ct0') document.getElementById('ct0').value = val;
  }
});

// --- Cookie ä¿å­˜ ---
async function saveCookies() {
  const btn = document.getElementById('save-btn');
  const res = document.getElementById('save-result');
  const authToken = document.getElementById('auth-token').value.trim();
  const ct0 = document.getElementById('ct0').value.trim();

  if (!authToken || !ct0) {
    res.className = 'result err';
    res.textContent = 'auth_token ã¨ ct0 ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'â³ ãƒ†ã‚¹ãƒˆä¸­...';
  res.className = 'result';
  res.style.display = 'none';

  try {
    const r = await fetch(API + '/settings/twitter-cookies', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ auth_token: authToken, ct0: ct0 }),
    });
    const data = await r.json();

    if (r.ok && data.valid) {
      res.className = 'result ok';
      res.textContent = `âœ… Cookie ä¿å­˜ & æ¤œè¨¼æˆåŠŸ (version: ${data.version})`;
    } else if (r.ok) {
      res.className = 'result err';
      res.textContent = `âš ï¸ Cookie ã¯ä¿å­˜ã—ã¾ã—ãŸãŒæ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
    } else {
      res.className = 'result err';
      res.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.detail || JSON.stringify(data)}`;
    }
  } catch (e) {
    res.className = 'result err';
    res.textContent = `âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ’¾ ä¿å­˜ & ãƒ†ã‚¹ãƒˆ';
    checkStatus();
  }
}

// --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª ---
async function checkStatus() {
  // Cookie ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  try {
    const r = await fetch(API + '/settings/twitter-cookies');
    const d = await r.json();
    const el = document.getElementById('cookie-status');
    if (d.has_cookies) {
      el.innerHTML = `<span class="dot green"></span>è¨­å®šæ¸ˆã¿ (${d.auth_token_preview})`;
    } else {
      el.innerHTML = `<span class="dot red"></span>æœªè¨­å®š`;
    }
  } catch { document.getElementById('cookie-status').innerHTML = `<span class="dot red"></span>æ¥ç¶šã‚¨ãƒ©ãƒ¼`; }

  // Health
  try {
    const r = await fetch(API + '/health');
    const d = await r.json();
    document.getElementById('broker-status').innerHTML = d.ok
      ? `<span class="dot green"></span>æ¥ç¶šæ¸ˆã¿`
      : `<span class="dot red"></span>ã‚¨ãƒ©ãƒ¼`;
    document.getElementById('llm-status').innerHTML = `<span class="dot green"></span>Ready`;
  } catch {
    document.getElementById('broker-status').innerHTML = `<span class="dot red"></span>æ¥ç¶šã‚¨ãƒ©ãƒ¼`;
    document.getElementById('llm-status').innerHTML = `<span class="dot red"></span>æ¥ç¶šã‚¨ãƒ©ãƒ¼`;
  }

  // ã‚·ã‚°ãƒŠãƒ«
  try {
    const r = await fetch(API + '/signals');
    const signals = await r.json();
    const tbody = document.getElementById('signals-body');
    if (!signals.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted)">ã‚·ã‚°ãƒŠãƒ«ãªã—</td></tr>';
    } else {
      tbody.innerHTML = signals.slice(0, 30).map(s => `
        <tr>
          <td>${new Date(s.created_at).toLocaleString('ja-JP')}</td>
          <td><strong>$${s.ticker}</strong></td>
          <td class="${s.side === 'BUY' ? 'side-buy' : 'side-sell'}">${s.side}</td>
          <td>${s.confidence != null ? (s.confidence * 100).toFixed(0) + '%' : '-'}</td>
          <td>${s.author || '-'}</td>
        </tr>
      `).join('');
    }
  } catch { document.getElementById('signals-body').innerHTML = '<tr><td colspan="5" style="color:var(--muted)">èª­è¾¼ã‚¨ãƒ©ãƒ¼</td></tr>'; }

  // æ³¨æ–‡
  try {
    const r = await fetch(API + '/orders');
    const orders = await r.json();
    const tbody = document.getElementById('orders-body');
    if (!orders.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted)">æ³¨æ–‡ãªã—</td></tr>';
    } else {
      tbody.innerHTML = orders.slice(0, 30).map(o => `
        <tr>
          <td>${new Date(o.created_at).toLocaleString('ja-JP')}</td>
          <td><strong>$${o.ticker}</strong></td>
          <td class="${o.side === 'BUY' ? 'side-buy' : 'side-sell'}">${o.side}</td>
          <td>${o.qty}</td>
          <td>${o.status}</td>
        </tr>
      `).join('');
    }
  } catch { document.getElementById('orders-body').innerHTML = '<tr><td colspan="5" style="color:var(--muted)">èª­è¾¼ã‚¨ãƒ©ãƒ¼</td></tr>'; }
}

// åˆå›ãƒ­ãƒ¼ãƒ‰
checkStatus();
// 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
setInterval(checkStatus, 30000);
</script>
</body>
</html>
